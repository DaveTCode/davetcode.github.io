<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.83.1"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#2b5797"><meta name=theme-color content="#ffffff"><title>Bringing emulation into the 21st century - David Tyler's Blog</title><meta name=author content="David Tyler"><meta name=description content="Implementing an 8080 emulator in a microservice architecture on top of kubernetes"><meta name=keywords content="emulation,8080,spaceinvaders,satire"><meta property="og:title" content="Bringing emulation into the 21st century"><meta name=twitter:title content="Bringing emulation into the 21st century"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.davetcode.co.uk/post/21st-century-emulator/"><meta property="og:description" content="Implementing an 8080 emulator in a microservice architecture on top of kubernetes"><meta name=twitter:description content="Implementing an 8080 emulator in a microservice architecture on top of kubernetes"><meta property="og:image" content="https://blog.davetcode.co.uk/space-invaders/images/space_invaders.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.davetcode.co.uk/space-invaders/images/space_invaders.png"><meta property="article:published_time" content="2021-05-01T13:33:09+00:00"><meta property="article:modified_time" content="2021-05-01T13:33:09+00:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://blog.davetcode.co.uk/assets/css/fuji.min.css></head><body data-theme=auto><script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');fujiThemeData?fujiThemeData!=='auto'&&document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light'):localStorage.setItem('fuji_data-theme','auto')</script><header><div class="container-xl clearfix"><div class="col-12 header"><a class=title-main href=https://blog.davetcode.co.uk/>David Tyler's Blog</a>
<span class=title-sub>Tecnical writing mostly focused on emulating old systems.</span></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://blog.davetcode.co.uk/post/21st-century-emulator/>Bringing emulation into the 21st century</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-05-01</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;3051 words</span>
<span><i class="iconfont icon-time-sharp"></i>&nbsp;15 minutes</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/emulation>emulation</a>&nbsp;<a href=/tags/8080>8080</a>&nbsp;<a href=/tags/spaceinvaders>spaceinvaders</a>&nbsp;<a href=/tags/satire>satire</a>&nbsp;</span></div><div class="post-content markdown-body"><p>Emulation is a fascinating area of software engineering, being able to bring to life a 30+ year old arcade machine on a modern computer is an incredibly satisfying accomplishment. Unfortunately I&rsquo;ve become increasingly disillusioned with the lack of ambition shown by those in the emulation community. Whilst the rest of world moves onto cloud first, massively distributed architectures, emulation is still stuck firmly in the 20th century writing single threaded <em>C++</em> of all things.</p><p>This project was born out of a desire to bring the best of modern design back to the the future of ancient computing history.</p><p><div class="image-wrapper ratio-21x9"><img class="lazyload img-zoomable" data-src=/21st-century-emulator/space-invaders-to-aks.png alt="Space Invaders Arcade Cabinet"></div></p><p>So what can the best of modern architecture bring to the emulation scene?</p><ul><li>Hot swappable code paths allowing for in game debugging</li><li>Different languages for different components</li><li>Secure by default (mTLS on all function calls)</li><li>Scalability</li><li>Fault tolerance</li><li>Cloud native design</li></ul><p>This culminated in the implementation of an <a href=https://en.wikipedia.org/wiki/Intel_8080 target=_blank>8080 microprocessor</a> utilising a modern, containerised, microservices based architecture running on <a href=https://kubernetes.io/ target=_blank>kubernetes</a> with frontends for a <a href=https://en.wikipedia.org/wiki/CP/M target=_blank>CP/M</a> test harness and a full implementation of the original <a href=https://en.wikipedia.org/wiki/Space_Invaders target=_blank>Space Invaders arcade machine</a>.</p><p>The full project can be found as a github organisation <a href=https://github.com/21st-century-emulation target=_blank>https://github.com/21st-century-emulation</a> which contains ~60 individual repositories each implementing an individual microservice or providing the infrastructure. This article goes into details on the technical architecture and issues I ran into with the project.</p><p>Key starting points to learn more are:</p><ol><li>A react based 8080 disassembler running on github pages - <a href=https://github.com/21st-century-emulation/disassembler-8080 target=_blank>https://github.com/21st-century-emulation/disassembler-8080</a></li><li>The CP/M test harness used to validate the processor - <a href=https://github.com/21st-century-emulation/cpm-test-harness target=_blank>https://github.com/21st-century-emulation/cpm-test-harness</a><ol><li>Just use <code>docker-compose up --build</code> in this repo to run the application</li></ol></li><li>Space Invaders UI - <a href=https://github.com/21st-century-emulation/space-invaders-ui target=_blank>https://github.com/21st-century-emulation/space-invaders-ui</a><ol><li>Run locally with <code>docker-compose up --build</code> or use the following project to deploy into kubernetes</li></ol></li><li>Kubernetes Configuration & Deploying - <a href=https://github.com/21st-century-emulation/space-invaders-kubernetes-infrastructure target=_blank>https://github.com/21st-century-emulation/space-invaders-kubernetes-infrastructure</a><ol><li>Note that this presupposes that you have access to a kubernetes cluster which can handle ~200 new pods</li></ol></li></ol><p>Finally, a screenshot of the emulator in action can be seen here:</p><p><div class="image-wrapper ratio-21x9"><img class="lazyload img-zoomable" data-src=/21st-century-emulator/space-invaders-ui-aks.png alt="Space Invaders UI"></div></p><h2 id=architectural-overview>Architectural Overview</h2><p>The following image describes the full archictectural model as applied to a space invaders arcade machine, the key components are then drawn out in the following sections</p><p><div class="image-wrapper ratio-16x9"><img class="lazyload img-zoomable" data-src=/21st-century-emulator/space-invaders-architecture.svg alt="Space Invaders UI"></div></p><h3 id=central-fetch-execute-loop>Central Fetch Execute Loop</h3><p>All old school emulators fall into one of two camps, either they step the CPU one instruction at a time and then catch up other components or they step each component (including the CPU) one
cycle at a time. The 8080 as played in a space invaders cabinet gains nothing from being emulated with cycle level accuracy so this emulator adheres to the former design.
The <code>Fetch Execute Loop</code> service is the service which then performs that core loop and is broadly shaped as follows</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>while</span> <span style=color:#66d9ef>true</span>:
  <span style=color:#a6e22e>Call</span> <span style=color:#66d9ef>microservice</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>check</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>interrupts</span> <span style=color:#66d9ef>should</span> <span style=color:#66d9ef>occur</span>
    <span style=color:#a6e22e>If</span> <span style=color:#66d9ef>so</span> <span style=color:#66d9ef>then</span> <span style=color:#66d9ef>run</span> <span style=color:#66d9ef>RST</span> <span style=color:#66d9ef>x</span> <span style=color:#66d9ef>instruction</span>
  
  <span style=color:#a6e22e>Get</span> <span style=color:#66d9ef>next</span> <span style=color:#66d9ef>instruction</span> <span style=color:#66d9ef>from</span> <span style=color:#66d9ef>memory</span> <span style=color:#66d9ef>bus</span> <span style=color:#66d9ef>microservice</span>

  <span style=color:#a6e22e>Call</span> <span style=color:#66d9ef>corresponding</span> <span style=color:#66d9ef>opcode</span> <span style=color:#66d9ef>microservice</span>
</code></pre></div><p>That&rsquo;s it. In order to actually drive this microservice we also provide <code>/api/v1/start</code> and <code>/api/v1/state</code> endpoints which correspondingly trigger a new instance of the CPU to run and get the status of the currently running CPU.</p><h3 id=opcode-microservices>Opcode microservices</h3><p>Every opcode corresponds to a microservice which must provide a POST api at <code>/api/v1/execute</code> taking a JSON body shaped as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;uuid&#34;</span>,
  <span style=color:#f92672>&#34;opcode&#34;</span>: <span style=color:#ae81ff>123</span>, <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#960050;background-color:#1e0010>Current</span> <span style=color:#960050;background-color:#1e0010>opcode</span> <span style=color:#960050;background-color:#1e0010>used</span> <span style=color:#960050;background-color:#1e0010>to</span> <span style=color:#960050;background-color:#1e0010>disambiguate</span> <span style=color:#960050;background-color:#1e0010>calls</span> <span style=color:#960050;background-color:#1e0010>to</span> <span style=color:#960050;background-color:#1e0010>e.g.</span> <span style=color:#960050;background-color:#1e0010>MOV</span> <span style=color:#960050;background-color:#1e0010>(MOV</span> <span style=color:#960050;background-color:#1e0010>B,C</span> <span style=color:#960050;background-color:#1e0010>or</span> <span style=color:#960050;background-color:#1e0010>MOV</span> <span style=color:#960050;background-color:#1e0010>B,D)</span>
  <span style=color:#f92672>&#34;state&#34;</span>: {
    <span style=color:#f92672>&#34;a&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;b&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;c&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;d&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;e&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;h&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;l&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;flags&#34;</span>: {
      <span style=color:#f92672>&#34;sign&#34;</span>: <span style=color:#66d9ef>false</span>,
      <span style=color:#f92672>&#34;zero&#34;</span>: <span style=color:#66d9ef>false</span>,
      <span style=color:#f92672>&#34;auxCarry&#34;</span>: <span style=color:#66d9ef>false</span>,
      <span style=color:#f92672>&#34;parity&#34;</span>: <span style=color:#66d9ef>false</span>,
      <span style=color:#f92672>&#34;carry&#34;</span>: <span style=color:#66d9ef>false</span>,
    },
    <span style=color:#f92672>&#34;programCounter&#34;</span>: <span style=color:#ae81ff>100</span>,
    <span style=color:#f92672>&#34;stackPointer&#34;</span>: <span style=color:#ae81ff>1000</span>,
    <span style=color:#f92672>&#34;cyclesTaken&#34;</span>: <span style=color:#ae81ff>2000</span>,
    <span style=color:#f92672>&#34;interruptsEnabled&#34;</span>: <span style=color:#66d9ef>false</span>,
  }
}
</code></pre></div><h3 id=memory-bus>Memory bus</h3><p>The memory bus serves to provide the stateful storage for the service and must expose 4 routes to the other services:</p><ol><li><code>/api/v1/readByte?id=${cpuId}&address=${u16}</code> - Read a single byte from the address passed in</li><li><code>/api/v1/writeByte?id=${cpuId}&address=${u16}&value=${u8}</code> - Write a single byte to the address passed in</li><li><code>/api/v1/readRange?id=${cpuId}&address=${u16}&length=${u16}</code> - Read at most <code>length</code> bytes starting at address (to get e.g. the 3 bytes that correspond to an instruction)</li><li><code>/api/v1/initialise?id=${cpuId}</code> - POST takes a base64 encoded string as body and uses that to initialise the memory bus for the cpu id passed in</li></ol><p>There&rsquo;s a simple & fast implementation written in rust with a high tech in memory database provided at <a href=https://github.com/21st-century-emulation/memory-bus-8080 target=_blank>https://github.com/21st-century-emulation/memory-bus-8080</a>. Alternative implementations utilising persistent storage are left as an exercise for the reader. A blockchain based backend is probably the best solution to this problem.</p><h3 id=interrupt-service>Interrupt service</h3><p>When running the fetch execute loop service you can optionally provide (via an environment variable) the url to an interrupt check service which will be called before every opcode is executed. This API must take the same JSON body as the opcode microservices and will return an optional value which indicates which RST opcode is to be taken (or none if no interrupt is to be fired).</p><h2 id=deployment-architecture>Deployment architecture</h2><p>Whilst the application can be run locally using <code>docker-compose</code>, no self-respecting cloud solutions architect would be satisfied with the risks inherent in having everything pinned to a single machine. Consequently this project also delivers a <a href=https://helm.sh/ target=_blank>helm</a> chart which can be found <a href=https://github.com/21st-century-emulation/space-invaders-kubernetes-infrastructure target=_blank>here</a>.</p><p>Given that repository and a suitably large kubernetes cluster (note: we strongly recommend choosing a top tier cloud provider like IBM for this), all components can be installed by simply running <code>./install.sh</code>.</p><p>The kubernetes architecture is outlined in <a href=https://github.com/21st-century-emulation/space-invaders-kubernetes-infrastructure/blob/main/README.md target=_blank>https://github.com/21st-century-emulation/space-invaders-kubernetes-infrastructure/blob/main/README.md</a> but a diagram is provided here for brevity:</p><p><div class="image-wrapper ratio-16x9"><img class="lazyload img-zoomable" data-src=/21st-century-emulator/space-invaders-kubernetes-architecture.svg alt="Space Invaders Kubernetes Architecture"></div></p><h2 id=performance>Performance</h2><p>As with all modern design it&rsquo;s crucial to adhere to the model of &ldquo;make it work <em>then</em> make it fast&rdquo; and that&rsquo;s something that this project really takes to heart. In 1974 when the 8080 was released it achieved a staggering 2MHz. Our new modern, containerised, cloud first design doesn&rsquo;t quite achieve that in it&rsquo;s initial iteration. As can be seen from the screenshot above, space invaders as deployed onto an AKS cluster runs at ~1KHz which gives us ample time for debugging but does make actually <em>playing</em> it slightly difficult.</p><p>However, now that the application works we can look at optimising it, the following are clear future directions for it to go in:</p><ol><li>Rewrite more things in rust. As we can see in the image below, a significant portion of the total CPU time was spent running <code>LXI</code> & <code>POP</code> opcodes. This is quite understandable because <code>LXI</code> is written in Java/Spring and <code>POP</code> is written in Scala/Play. Both are clearly orders of magnitude slower than all the other languages in play here.<p><div class="image-wrapper ratio-40x9"><img class="lazyload img-zoomable" data-src=/21st-century-emulator/space-invaders-pod-metrics.png alt="Space Invaders Pod Metrics"></div></p></li><li>JSON -> Avro/Protobuf. JSON serialisation/deserialisation is known to be too slow for modern applications, using a better binary packed format will obviously increase performance</li><li>Pipelining & speculative execution.<ol><li>A minor speed boost can be achieved by simply pipelining up to the next N instructions and invalidating the pipeline on any instruction which changes the program counter. This is particularly excellent because it brings modern CPU design back to the 8080!</li><li>Since all operations internally are async and wait on IO we can trivially execute multiple instructions in parallel, a further enhancement would therefore be to speculatively execute instructions and rollback if the execution of a previous one would have affected the result.</li></ol></li><li>Memory caches<ol><li>Having to access the memory bus each time is slow, by noting which instructions can affect memory we are able to act like a modern VM and cache memory until a write happens at which point we invalidate the cache and continue. See the below image showcasing the amount of requests made to <code>/api/v1/readRange</code> form the fetch execute loop (which uses that API to get the next instruction).<p><div class="image-wrapper ratio-40x9"><img class="lazyload img-zoomable" data-src=/21st-century-emulator/space-invaders-linkerd-variance.png alt="Space Invaders API Calls"></div></p></li></ol></li></ol><h2 id=implementation-details>Implementation Details</h2><p>One of the many beautiful things about a microservice architecture is that, because function calls are now HTTP over TCP, we&rsquo;re no longer limited to a single language in our environment. That allows us to really leverage the best that modern http api design has to offer.</p><p>The following table outlines the language choice for each opcode, as you can see, this allows to gain the benefits of Rusts safe integer arithmetic operations whilst falling back to the security of Deno for important operations like CALL & RET.</p><table><thead><tr><th>Opcode</th><th>Language</th><th>Description</th><th>Runtime image size</th><th>Performance (avg latency)</th></tr></thead><tbody><tr><td><a href=https://github.com/21st-century-emulation/mov target=_blank>MOV</a></td><td>Swift</td><td>Moves data from one register to another</td><td>257MB</td><td>4.68ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/mvi target=_blank>MVI</a></td><td>Javascript</td><td>Puts 8 bits into register, or memory</td><td>118MB</td><td>3.43ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/lda target=_blank>LDA</a></td><td>VB</td><td>Puts 8 bits at location Addr into A Register</td><td>206MB</td><td>4.56ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/sta target=_blank>STA</a></td><td>C#</td><td>Stores 8 bits at location Addr</td><td>206MB</td><td>4.61ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ldax target=_blank>LDAX</a></td><td>Typescript</td><td>Loads A register with 8 bits from location in BC or DE</td><td>365MB</td><td>6.22ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/stax target=_blank>STAX</a></td><td>Python</td><td>Stores A register at location in BC or DE</td><td>59MB</td><td>5.24ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/lhld target=_blank>LHLD</a></td><td>Ruby</td><td>Loads HL register with 16 bits found at Addr and Addr+1</td><td>898MB!</td><td>13.63ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/shld target=_blank>SHLD</a></td><td>Perl</td><td>Stores HL register contents at Addr and Addr+1</td><td>930MB!</td><td>12.68ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/lxi target=_blank>LXI</a></td><td>Java + Spring</td><td>Loads 16 bits into B,D,H, or SP</td><td>415MB</td><td>6.84ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/push target=_blank>PUSH</a></td><td>Lua</td><td>Puts 16 bits of BP onto stack SP=SP-2</td><td>385MB</td><td>4.42ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/pop target=_blank>POP</a></td><td>Scala + Play</td><td>Takes top of stack, puts it in RP SP=SP+2</td><td>761MB</td><td>13.99ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/xthl target=_blank>XTHL</a></td><td>D</td><td>Exchanges HL with top of stack</td><td>156MB</td><td>26.54ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/sphl target=_blank>SPHL</a></td><td>F#</td><td>Puts contents of HL into SP (stack pointer)</td><td>114MB</td><td>3.25ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/pchl target=_blank>PCHL</a></td><td>Kotlin</td><td>Puts contents of HL into PC (program counter) [=JMP (HL)]</td><td>445MB</td><td>7.61ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/xchg target=_blank>XCHG</a></td><td>C++</td><td>Exchanges HL and DE</td><td>514MB</td><td>2.16ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/add target=_blank>ADD</a></td><td>Rust</td><td>Add accumulator and register/(HL)</td><td>123MB</td><td>1.95ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/adc target=_blank>ADC</a></td><td>Rust</td><td>Add accumulator and register/(HL) (with carry)</td><td>123MB</td><td>2.00ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/adi target=_blank>ADI</a></td><td>Rust</td><td>Add accumulator and immediate</td><td>123MB</td><td>2.16ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/aci target=_blank>ACI</a></td><td>Rust</td><td>Add accumulator and immediate (with carry)</td><td>123MB</td><td>2.22ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/sub target=_blank>SUB</a></td><td>Rust</td><td>Sub accumulator and register/(HL)</td><td>123MB</td><td>1.95ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/sbb target=_blank>SBB</a></td><td>Rust</td><td>Sub accumulator and register/(HL) (with borrow)</td><td>123MB</td><td>1.70ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/sui target=_blank>SUI</a></td><td>Rust</td><td>Sub accumulator and immediate</td><td>123MB</td><td>2.15ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/sbi target=_blank>SBI</a></td><td>Rust</td><td>Sub accumulator and immediate (with carry)</td><td>123MB</td><td>1.91ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ana target=_blank>ANA</a></td><td>Rust</td><td>And accumulator and register/(HL)</td><td>123MB</td><td>2.68ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ani target=_blank>ANI</a></td><td>Rust</td><td>And accumulator and immediate</td><td>123MB</td><td>1.93ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/xra target=_blank>XRA</a></td><td>Rust</td><td>Xor accumulator and register/(HL)</td><td>123MB</td><td>1.70ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/xri target=_blank>XRI</a></td><td>Rust</td><td>Xor accumulator and immediate</td><td>123MB</td><td>1.57ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ora target=_blank>ORA</a></td><td><del>Rust</del> Nim</td><td>Or accumulator and register/(HL)</td><td>74MB</td><td>11.36ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ori target=_blank>ORI</a></td><td>Rust</td><td>Or accumulator and immediate</td><td>123MB</td><td>1.40ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/daa target=_blank>DAA</a></td><td>Rust</td><td>Decimal adjust accumulator</td><td>123MB</td><td>2.26ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/cmp target=_blank>CMP</a></td><td>Rust</td><td>Compare accumulator and register/(HL)</td><td>123MB</td><td>1.70ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/cpi target=_blank>CPI</a></td><td>Rust</td><td>Compare accumulator and immediate</td><td>123MB</td><td>1.90ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/dad target=_blank>DAD</a></td><td>PHP</td><td>Adds contents of register RP to contents of HL register</td><td>430MB</td><td>17.2 ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/inr target=_blank>INR</a></td><td>Crystal</td><td>Increments register</td><td>23MB</td><td>1.98ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/dcr target=_blank>DCR</a></td><td>Crystal</td><td>Decrements register</td><td>23MB</td><td>2.06ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/inx target=_blank>INX</a></td><td>Crystal</td><td>Increments register pair</td><td>23MB</td><td>2.01ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/dcx target=_blank>DCX</a></td><td>Crystal</td><td>Decrements register pair</td><td>23MB</td><td>1.99ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/jmp target=_blank>JMP</a></td><td>Powershell</td><td>Unconditional Jump to location Addr</td><td>294MB</td><td>6.51ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/call target=_blank>CALL</a></td><td>Deno</td><td>Unconditional Subroutine call to location Addr</td><td>154MB</td><td>6.04ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ret target=_blank>RET</a></td><td>Deno</td><td>Unconditional return from subroutine</td><td>154MB</td><td>6.43ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/rlc target=_blank>RLC</a></td><td>Go</td><td>Rotate left carry</td><td>6MB</td><td>2.28ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/rrc target=_blank>RRC</a></td><td>Go</td><td>Rotate right carry</td><td>6MB</td><td>2.19ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ral target=_blank>RAL</a></td><td>Go</td><td>Rotate left accumulator</td><td>6MB</td><td>2.39ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/rar target=_blank>RAR</a></td><td>Go</td><td>Rotate right accumulator</td><td>6MB</td><td>2.29ms</td></tr><tr><td>IN</td><td></td><td>Data from Port placed in A register</td><td></td><td></td></tr><tr><td>OUT</td><td></td><td>Data from A register placed in Port</td><td></td><td></td></tr><tr><td><a href=https://github.com/21st-century-emulation/cmc target=_blank>CMC</a></td><td>Haskell</td><td>Complement Carry Flag</td><td>90MB</td><td>2.50ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/cma target=_blank>CMA</a></td><td>Haskell</td><td>Complement A register</td><td>90MB</td><td>2.54ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/stc target=_blank>STC</a></td><td>Haskell</td><td>Set Carry Flag = 1</td><td>90MB</td><td>2.52ms</td></tr><tr><td>HLT</td><td></td><td>Halt CPU and wait for interrupt</td><td></td><td></td></tr><tr><td><a href=https://github.com/21st-century-emulation/noop target=_blank>NOOP</a></td><td>C</td><td>No operation</td><td>70MB</td><td>1.89ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/di target=_blank>DI</a></td><td>Dart</td><td>Disable Interrupts</td><td>79MB</td><td>2.37ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/ei target=_blank>EI</a></td><td>Dart</td><td>Enable Interrupts</td><td>79MB</td><td>2.21ms</td></tr><tr><td><a href=https://github.com/21st-century-emulation/rst target=_blank>RST</a></td><td>Deno</td><td>Call interrupt vector</td><td>154MB</td><td>7.34ms</td></tr></tbody></table><p>Nim was a bit late to the party so only got one opcode, and it still managed to be slow anyway.</p><h3 id=code-details>Code details</h3><p>According to <a href=https://github.com/boyter/scc target=_blank>SCC</a> this project cost $1M to make, which is probably several orders of magnitude less than Google will pay for it. Like any true modern application it also consists of significantly more JSON/YAML than code.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#960050;background-color:#1e0010>───────────────────────────────────────────────────────────────────────────────</span>
<span style=color:#a6e22e>Language</span>                 <span style=color:#66d9ef>Files</span>     <span style=color:#66d9ef>Lines</span>   <span style=color:#66d9ef>Blanks</span>  <span style=color:#66d9ef>Comments</span>     <span style=color:#66d9ef>Code</span> <span style=color:#66d9ef>Complexity</span>
<span style=color:#960050;background-color:#1e0010>───────────────────────────────────────────────────────────────────────────────</span>
<span style=color:#a6e22e>YAML</span>                       <span style=color:#ae81ff>144</span>      <span style=color:#ae81ff>6873</span>      <span style=color:#ae81ff>859</span>       <span style=color:#ae81ff>396</span>     <span style=color:#ae81ff>5618</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Dockerfile</span>                 <span style=color:#ae81ff>112</span>      <span style=color:#ae81ff>2007</span>      <span style=color:#ae81ff>505</span>       <span style=color:#ae81ff>353</span>     <span style=color:#ae81ff>1149</span>        <span style=color:#ae81ff>248</span>
<span style=color:#a6e22e>JSON</span>                       <span style=color:#ae81ff>106</span>     <span style=color:#ae81ff>15383</span>      <span style=color:#ae81ff>240</span>         <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>15143</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Shell</span>                       <span style=color:#ae81ff>64</span>      <span style=color:#ae81ff>2448</span>      <span style=color:#ae81ff>369</span>       <span style=color:#ae81ff>195</span>     <span style=color:#ae81ff>1884</span>        <span style=color:#ae81ff>257</span>
<span style=color:#a6e22e>Plain</span> <span style=color:#66d9ef>Text</span>                  <span style=color:#ae81ff>59</span>       <span style=color:#ae81ff>404</span>      <span style=color:#ae81ff>171</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>233</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Docker</span> <span style=color:#66d9ef>ignore</span>               <span style=color:#ae81ff>56</span>       <span style=color:#ae81ff>295</span>        <span style=color:#ae81ff>0</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>295</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Markdown</span>                    <span style=color:#ae81ff>56</span>       <span style=color:#ae81ff>545</span>      <span style=color:#ae81ff>165</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>380</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>gitignore</span>                   <span style=color:#ae81ff>56</span>       <span style=color:#ae81ff>847</span>      <span style=color:#ae81ff>129</span>       <span style=color:#ae81ff>178</span>      <span style=color:#ae81ff>540</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>C</span><span style=color:#75715e>#                          35      1803      198        10     1595         51
</span><span style=color:#75715e></span><span style=color:#66d9ef>TypeScript</span>                  <span style=color:#ae81ff>22</span>      <span style=color:#ae81ff>1335</span>      <span style=color:#ae81ff>116</span>        <span style=color:#ae81ff>30</span>     <span style=color:#ae81ff>1189</span>        <span style=color:#ae81ff>275</span>
<span style=color:#a6e22e>Rust</span>                        <span style=color:#ae81ff>18</span>      <span style=color:#ae81ff>1825</span>      <span style=color:#ae81ff>241</span>         <span style=color:#ae81ff>7</span>     <span style=color:#ae81ff>1577</span>         <span style=color:#ae81ff>79</span>
<span style=color:#a6e22e>TOML</span>                        <span style=color:#ae81ff>18</span>       <span style=color:#ae81ff>245</span>       <span style=color:#ae81ff>20</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>225</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Java</span>                         <span style=color:#ae81ff>7</span>       <span style=color:#ae81ff>306</span>       <span style=color:#ae81ff>66</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>240</span>          <span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>Haskell</span>                      <span style=color:#ae81ff>6</span>       <span style=color:#ae81ff>207</span>       <span style=color:#ae81ff>24</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>183</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Visual</span> <span style=color:#66d9ef>Basic</span>                 <span style=color:#ae81ff>6</span>       <span style=color:#ae81ff>119</span>       <span style=color:#ae81ff>24</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>95</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>MSBuild</span>                      <span style=color:#ae81ff>5</span>        <span style=color:#ae81ff>53</span>       <span style=color:#ae81ff>13</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>40</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Crystal</span>                      <span style=color:#ae81ff>4</span>       <span style=color:#ae81ff>330</span>       <span style=color:#ae81ff>68</span>         <span style=color:#ae81ff>4</span>      <span style=color:#ae81ff>258</span>          <span style=color:#ae81ff>5</span>
<span style=color:#a6e22e>Go</span>                           <span style=color:#ae81ff>4</span>       <span style=color:#ae81ff>255</span>       <span style=color:#ae81ff>33</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>222</span>          <span style=color:#ae81ff>6</span>
<span style=color:#a6e22e>JavaScript</span>                   <span style=color:#ae81ff>4</span>       <span style=color:#ae81ff>147</span>        <span style=color:#ae81ff>8</span>         <span style=color:#ae81ff>1</span>      <span style=color:#ae81ff>138</span>          <span style=color:#ae81ff>5</span>
<span style=color:#a6e22e>License</span>                      <span style=color:#ae81ff>4</span>        <span style=color:#ae81ff>84</span>       <span style=color:#ae81ff>16</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>68</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>PHP</span>                          <span style=color:#ae81ff>4</span>       <span style=color:#ae81ff>147</span>       <span style=color:#ae81ff>21</span>        <span style=color:#ae81ff>43</span>       <span style=color:#ae81ff>83</span>          <span style=color:#ae81ff>2</span>
<span style=color:#a6e22e>Swift</span>                        <span style=color:#ae81ff>4</span>       <span style=color:#ae81ff>283</span>       <span style=color:#ae81ff>15</span>         <span style=color:#ae81ff>4</span>      <span style=color:#ae81ff>264</span>          <span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>C</span><span style=color:#960050;background-color:#1e0010>++</span>                          <span style=color:#ae81ff>3</span>        <span style=color:#ae81ff>32</span>        <span style=color:#ae81ff>4</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>28</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Emacs</span> <span style=color:#66d9ef>Lisp</span>                   <span style=color:#ae81ff>3</span>        <span style=color:#ae81ff>12</span>        <span style=color:#ae81ff>0</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>12</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Scala</span>                        <span style=color:#ae81ff>3</span>       <span style=color:#ae81ff>112</span>       <span style=color:#ae81ff>15</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>97</span>          <span style=color:#ae81ff>6</span>
<span style=color:#a6e22e>XML</span>                          <span style=color:#ae81ff>3</span>        <span style=color:#ae81ff>97</span>       <span style=color:#ae81ff>13</span>         <span style=color:#ae81ff>1</span>       <span style=color:#ae81ff>83</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>C</span> <span style=color:#66d9ef>Header</span>                     <span style=color:#ae81ff>2</span>        <span style=color:#ae81ff>24</span>        <span style=color:#ae81ff>2</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>22</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>CSS</span>                          <span style=color:#ae81ff>2</span>        <span style=color:#ae81ff>44</span>        <span style=color:#ae81ff>6</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>38</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Dart</span>                         <span style=color:#ae81ff>2</span>        <span style=color:#ae81ff>58</span>        <span style=color:#ae81ff>6</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>52</span>         <span style=color:#ae81ff>18</span>
<span style=color:#a6e22e>HTML</span>                         <span style=color:#ae81ff>2</span>       <span style=color:#ae81ff>361</span>        <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>360</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Lua</span>                          <span style=color:#ae81ff>2</span>        <span style=color:#ae81ff>65</span>        <span style=color:#ae81ff>8</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>57</span>         <span style=color:#ae81ff>15</span>
<span style=color:#a6e22e>Properties</span> <span style=color:#66d9ef>File</span>              <span style=color:#ae81ff>2</span>         <span style=color:#ae81ff>2</span>        <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>C</span>                            <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>63</span>        <span style=color:#ae81ff>8</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>55</span>         <span style=color:#ae81ff>18</span>
<span style=color:#a6e22e>CMake</span>                        <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>68</span>       <span style=color:#ae81ff>10</span>        <span style=color:#ae81ff>15</span>       <span style=color:#ae81ff>43</span>          <span style=color:#ae81ff>4</span>
<span style=color:#a6e22e>D</span>                            <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>71</span>        <span style=color:#ae81ff>6</span>         <span style=color:#ae81ff>2</span>       <span style=color:#ae81ff>63</span>         <span style=color:#ae81ff>14</span>
<span style=color:#a6e22e>F</span><span style=color:#75715e>#                           1        88       11         3       74          0
</span><span style=color:#75715e></span><span style=color:#66d9ef>Gemfile</span>                      <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>9</span>        <span style=color:#ae81ff>4</span>         <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>5</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Gradle</span>                       <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>32</span>        <span style=color:#ae81ff>4</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>28</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Kotlin</span>                       <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>40</span>        <span style=color:#ae81ff>9</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>31</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Makefile</span>                     <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>16</span>        <span style=color:#ae81ff>4</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>12</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Nim</span>                          <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>82</span>        <span style=color:#ae81ff>9</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>73</span>          <span style=color:#ae81ff>2</span>
<span style=color:#a6e22e>Perl</span>                         <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>49</span>        <span style=color:#ae81ff>6</span>         <span style=color:#ae81ff>3</span>       <span style=color:#ae81ff>40</span>          <span style=color:#ae81ff>4</span>
<span style=color:#a6e22e>Powershell</span>                   <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>78</span>        <span style=color:#ae81ff>9</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>69</span>         <span style=color:#ae81ff>10</span>
<span style=color:#a6e22e>Python</span>                       <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>37</span>        <span style=color:#ae81ff>6</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>31</span>          <span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>Ruby</span>                         <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>28</span>        <span style=color:#ae81ff>6</span>         <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>22</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>SVG</span>                          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>3</span>        <span style=color:#ae81ff>0</span>         <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>3</span>          <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>TypeScript</span> <span style=color:#66d9ef>Typings</span>           <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>0</span>         <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>0</span>          <span style=color:#ae81ff>0</span>
<span style=color:#960050;background-color:#1e0010>───────────────────────────────────────────────────────────────────────────────</span>
<span style=color:#a6e22e>Total</span>                      <span style=color:#ae81ff>833</span>     <span style=color:#ae81ff>37413</span>     <span style=color:#ae81ff>3449</span>      <span style=color:#ae81ff>1246</span>    <span style=color:#ae81ff>32718</span>       <span style=color:#ae81ff>1022</span>
<span style=color:#960050;background-color:#1e0010>───────────────────────────────────────────────────────────────────────────────</span>
<span style=color:#a6e22e>Estimated</span> <span style=color:#66d9ef>Cost</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>Develop</span> (<span style=color:#66d9ef>organic</span>) <span style=color:#66d9ef>$1</span>,<span style=color:#ae81ff>052</span>,<span style=color:#ae81ff>256</span>
<span style=color:#a6e22e>Estimated</span> <span style=color:#66d9ef>Schedule</span> <span style=color:#66d9ef>Effort</span> (<span style=color:#66d9ef>organic</span>) <span style=color:#ae81ff>14</span><span style=color:#66d9ef>.022330</span> <span style=color:#66d9ef>months</span>
<span style=color:#a6e22e>Estimated</span> <span style=color:#66d9ef>People</span> <span style=color:#66d9ef>Required</span> (<span style=color:#66d9ef>organic</span>) <span style=color:#ae81ff>6</span><span style=color:#66d9ef>.666796</span>
<span style=color:#960050;background-color:#1e0010>───────────────────────────────────────────────────────────────────────────────</span>
<span style=color:#a6e22e>Processed</span> <span style=color:#ae81ff>1473797</span> <span style=color:#66d9ef>bytes</span>, <span style=color:#ae81ff>1</span><span style=color:#66d9ef>.474</span> <span style=color:#66d9ef>megabytes</span> (<span style=color:#66d9ef>SI</span>)
<span style=color:#960050;background-color:#1e0010>───────────────────────────────────────────────────────────────────────────────</span>
</code></pre></div><h2 id=issues>Issues</h2><p>Naturally I ran into a number of new issues with this approach. I&rsquo;ve listed some of those below to give a flavour for the types of problems with this architecture:</p><ol><li>Github actions&mldr;<ol><li>Random timeouts logging in to ghcr.io, random timeouts pushing images. Generally just spontaneous errors of all sorts. This really drove home how fun it is managing the development toolchain for a microservice architecture</li></ol></li><li>Haskell compiler images<ol><li>Oh boy. Haskell won the award for my least favourite development environment solely off the back of the absurd <em>3.5GB</em> SDK image! That was sufficiently large that it was impossible to build the haskell based services in CI without fine tuning the image down to &lt; 3.4GB (github actions limits)</li></ol></li><li>Intermittent AKS networking errors<ol><li>Whilst it achieved ~4 9s availability across all microservices, there <em>were</em> spontaneous 504s between microservices in the AKS implementation.</li><li>On the plus side, because we&rsquo;re using linkerd as a service mesh to give us secure microservice TCP connections we can also just leverage it&rsquo;s retry behavior and forget about the problem! Exactly like a modern architecture!</li></ol></li><li>DNS caching (or not)<ol><li>Only node.js of all the languages used had issues where it would hammer the DNS server on literally every HTTP request, eventually DNS told it to piss off and the next request broke #justnodethings</li></ol></li><li>Logging at scale<ol><li>I initially set up Loki as the logging backend but found that the C# libraries for Loki would occasionally send requests out of order and that in the end Loki would just give up and stop accepting logs - fortunately fluentd is a much more cloud native way to do logging so it was obviously the best decision all along</li></ol></li><li>Orchestrating changes across services<ol><li>Strangely, having ~50 repositories to manage was marginally harder than having 1. Making a change to (for example) add an <code>interruptsEnabled</code> flag to the CPU needed to be orchestrated across all microservices. Fortunately I&rsquo;m quite good at writing disgusting bash scripts.</li></ol></li></ol><h2 id=is-this-actually-possible>Is this actually possible?</h2><p>Alright, if you&rsquo;ve got this far I&rsquo;m sure you&rsquo;ve realised that the whole project is something of a joke. That said it <em>is</em> also an interesting intellectual exercise to consider whether it&rsquo;s remotely possible to achieve >=2MHz with the architecture delivered.</p><p>The starting point is that to achieve 2MHz we must deliver 1 instruction every 2μs</p><pre><code>2MHz = 2,000,000 cycles per second
Each instruction is at 4-17 cycles so we need to manage at worst 2,000,000 / 4 = 500,000 instructions per second. That gives 1/500,000 seconds = ~2μs per operation.
</code></pre><p>Assuming for sake of argument that we do the following optimisations:</p><ul><li>Make interrupt checks off the hot path<ul><li>Reduces total HTTP requests per operation by 2</li></ul></li><li>Cache all ROM in the fetch execute service and assume applications only execute from ROM (true for space invaders)<ul><li>Reduces total HTTP requests per operation by another 2</li></ul></li><li>Change from JSON w/ UTF8 encoding to sending a byte packed array of values to represent the CPU<ul><li>Drives the request size down to &lt;256 bytes and eliminates all serialization/deserialization costs (just have a struct pointer pointing at the array)</li></ul></li></ul><p>Then we can get to a good starting point of exactly 1 round trip to/from each opcode. So what&rsquo;s the minimal cost for a roundtrip across network?</p><p>This answer (<a href=https://quant.stackexchange.com/questions/17620/what-is-the-current-lowest-possible-latency-for-tcp-communication target=_blank>https://quant.stackexchange.com/questions/17620/what-is-the-current-lowest-possible-latency-for-tcp-communication</a>) from 2015 benchmarks loopback device latency at ~2μs if the request size can be kept down to &lt;=256 bytes.</p><p>Assuming that person knows what they&rsquo;re talking about then the <em>immediate</em> answer is a straight no. You&rsquo;ll never achieve the required latency across a network (particularly a dodgy cloud data center network).</p><p>But let&rsquo;s not give up quite yet. We&rsquo;re not <em>miles</em> away from the performance required so we can look for 2 times speed ups.</p><p>Some thoughts on methods to get that last 2 times speed up:</p><ol><li>Fire and forget memory writes<ol><li>A memory write is almost never read immediately, so just chuck it at the bus and don&rsquo;t bother blocking until it&rsquo;s written. Maybe you&rsquo;ll lose some writes? That&rsquo;s fine. Very mongo.</li></ol></li><li>We can execute multiple operations in parallel and only validate the correctness of their results later.<ol><li>This would clearly speed up operations like memcpy&rsquo;s which are done with simple <code>MVI (HL) d8</code> -> <code>DCX HL</code> -> <code>JNZ</code> type algorithms where each grouping can be executed in parallel</li></ol></li><li>If each opcode was capable of knowing the next instruction then we could avoid the second half of each round trip and not travel back to the fetch execute loop until the stream of instructions has run out<ol><li>This is basically a guaranteed 2 times speed up</li></ol></li></ol><p>Conclusion? I think it <em>might</em> be possible under some ideal situations assuming ~no network latency but I&rsquo;ve no intention of spending any more time thinking about it!</p></div></article><div class="license markdown-body"><blockquote><p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a>.</p></blockquote></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/about>About</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/davetcode target=_blank><span>GitHub</span></a></li><li><a href=https://www.linkedin.com/in/datyler/ target=_blank><span>LinkedIn</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/8080/>8080</a></span>
<span><a href=/tags/clr/>clr</a></span>
<span><a href=/tags/csharp/>csharp</a></span>
<span><a href=/tags/emulation/>emulation</a></span>
<span><a href=/tags/rust/>rust</a></span>
<span><a href=/tags/satire/>satire</a></span>
<span><a href=/tags/spaceinvaders/>spaceinvaders</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><ul><li><a href=#architectural-overview>Architectural Overview</a><ul><li><a href=#central-fetch-execute-loop>Central Fetch Execute Loop</a></li><li><a href=#opcode-microservices>Opcode microservices</a></li><li><a href=#memory-bus>Memory bus</a></li><li><a href=#interrupt-service>Interrupt service</a></li></ul></li><li><a href=#deployment-architecture>Deployment architecture</a></li><li><a href=#performance>Performance</a></li><li><a href=#implementation-details>Implementation Details</a><ul><li><a href=#code-details>Code details</a></li></ul></li><li><a href=#issues>Issues</a></li><li><a href=#is-this-actually-possible>Is this actually possible?</a></li></ul></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/about>About</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/davetcode target=_blank><span>GitHub</span></a></li><li><a href=https://www.linkedin.com/in/datyler/ target=_blank><span>LinkedIn</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/8080/>8080</a></span>
<span><a href=/tags/clr/>clr</a></span>
<span><a href=/tags/csharp/>csharp</a></span>
<span><a href=/tags/emulation/>emulation</a></span>
<span><a href=/tags/rust/>rust</a></span>
<span><a href=/tags/satire/>satire</a></span>
<span><a href=/tags/spaceinvaders/>spaceinvaders</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><ul><li><a href=#architectural-overview>Architectural Overview</a><ul><li><a href=#central-fetch-execute-loop>Central Fetch Execute Loop</a></li><li><a href=#opcode-microservices>Opcode microservices</a></li><li><a href=#memory-bus>Memory bus</a></li><li><a href=#interrupt-service>Interrupt service</a></li></ul></li><li><a href=#deployment-architecture>Deployment architecture</a></li><li><a href=#performance>Performance</a></li><li><a href=#implementation-details>Implementation Details</a><ul><li><a href=#code-details>Code details</a></li></ul></li><li><a href=#issues>Issues</a></li><li><a href=#is-this-actually-possible>Is this actually possible?</a></li></ul></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2021-2021
<a href=https://blog.davetcode.co.uk/>David Tyler</a>
| <a href=https://github.com/davetcode>Source code</a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script></body></html>